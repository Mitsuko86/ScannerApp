<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Media Sniper Scanner</title>
<style>
  body { font-family: -apple-system, system-ui, sans-serif; margin: 16px; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-bottom: 12px; background: white; }
  input[type="text"], input[type="number"] { width: 100%; font-size: 22px; padding: 12px; border-radius: 10px; border: 1px solid #bbb; }
  button { font-size: 16px; padding: 10px 12px; border-radius: 10px; border: 1px solid #888; background: #f5f5f5; margin-right: 6px; margin-top: 6px; }
  ul { margin: 8px 0 0; padding-left: 18px; }
  .muted { color:#666; font-size: 13px; margin-top: 6px; line-height: 1.35; }

  /* Lane states (full-page background) */
  .lane-ebay    { background-color: #cfe2ff; transition: background-color 0.25s ease; }   /* blue */
  .lane-buyback { background-color: #c6f7c6; transition: background-color 0.25s ease; }   /* green */
  .lane-amazon  { background-color: #eadcff; transition: background-color 0.25s ease; }   /* purple */
  .lane-pass    { background-color: #ffd6d6; transition: background-color 0.25s ease; }   /* red */

  .statusLine {
    margin-top: 8px;
    font-size: 13px;
    color: #444;
    white-space: pre-wrap;
  }

  .pill {
    display: inline-block;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid #ddd;
    font-size: 13px;
    margin-right: 6px;
    margin-top: 6px;
    background: #fafafa;
  }

  /* Lane pill (big + obvious) */
  .pill-lane {
    font-weight: 800;
    border: 2px solid rgba(0,0,0,0.15);
    letter-spacing: 0.4px;
  }
  .pill-lane.ebay    { background: #0b5ed7; color: #fff; border-color: rgba(0,0,0,0.1); }
  .pill-lane.buyback { background: #198754; color: #fff; border-color: rgba(0,0,0,0.1); }
  .pill-lane.amazon  { background: #6f42c1; color: #fff; border-color: rgba(0,0,0,0.1); }
  .pill-lane.pass    { background: #dc3545; color: #fff; border-color: rgba(0,0,0,0.1); }

  .resultRow { margin-top: 10px; line-height: 1.5; }

  /* OCR framing guide box */
  .ocr-guide {
    position: relative;
    width: 100%;
    max-width: 520px;
    height: 140px;
    border: 3px dashed #666;
    border-radius: 14px;
    margin-top: 10px;
    background: rgba(0,0,0,0.03);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .ocr-guide span {
    font-size: 13px;
    color: #444;
    text-align: center;
    padding: 0 10px;
    line-height: 1.3;
  }
  .ocr-guide::after {
    content: "";
    position: absolute;
    left: 14px;
    right: 14px;
    top: 50%;
    height: 2px;
    background: rgba(0,0,0,0.25);
    transform: translateY(-50%);
  }
</style>
</head>
<body>

<h2>Media Sniper Scanner</h2>

<div class="card">
  <strong>eBay approved list loaded:</strong> <span id="countEbay">0</span> ISBNs<br><br>
  <input id="fileEbay" type="file" accept=".txt,.csv" />
  <div class="muted">Tip: one ISBN per line is best. ISBN-10 is normalized to ISBN-13 for matching. Dashes/spaces are OK.</div>
  <div id="persistStatusEbay" class="muted"></div>
  <button type="button" id="clearSavedEbay">Clear saved eBay list</button>
</div>

<div class="card">
  <strong>Amazon approved list loaded:</strong> <span id="countAmazon">0</span> ISBNs<br><br>
  <input id="fileAmazon" type="file" accept=".txt,.csv" />
  <div class="muted">This is your Keepa-generated consignment OK list (978...). Same matching behavior as eBay list.</div>
  <div id="persistStatusAmazon" class="muted"></div>
  <button type="button" id="clearSavedAmazon">Clear saved Amazon list</button>
</div>

<div class="card">
  <strong>BooksRun settings</strong>
  <div class="muted">Uses BooksRun "Average" offer for the buyback decision. Threshold is in USD.</div>
  <input id="minUsd" type="number" value="10" min="0" step="0.5" />
  <div class="muted">Minimum BooksRun Average (USD) to trigger BUYBACK (if not eBay-approved).</div>

  <div style="margin-top:10px;">
    <strong>Worker URL</strong>
    <div class="muted">Paste your Cloudflare Worker /lookup URL here once. It will be saved on your device.</div>
    <input id="workerUrl" type="text" placeholder="https://your-worker.workers.dev/lookup" />
    <button type="button" id="saveWorkerUrl">Save Worker URL</button>
    <div id="workerStatus" class="muted"></div>
  </div>
</div>

<div class="card">
  <input id="scan" type="text" placeholder="Scan ISBN..." autocomplete="off" />
  <br><br>

  <button id="enableSound" type="button">Enable sound</button>
  <div class="muted">On iPhone, tap this once so the beep can play.</div>

  <div style="margin-top:10px;">
    <button type="button" onclick="openEbaySoldHigh()">eBay Sold (High to Low)</button>
    <button type="button" onclick="openEbayLiveLow()">eBay Live (Low to High)</button>
    <button type="button" onclick="openKeepaGtin()">Keepa (GTIN search)</button>
  </div>

  <div style="margin-top:10px;">
    <button type="button" id="ocrBtn">Scan printed ISBN (photo)</button>
    <div class="muted">For older books with no barcode. Take a close photo of the ISBN line on the copyright page.</div>

    <div class="ocr-guide">
      <span>Frame the ISBN line across the center line, then tap “Scan printed ISBN (photo)”.</span>
    </div>
  </div>

  <input id="ocrInput" type="file" accept="image/*" capture="environment" style="display:none;" />

  <div id="ocrStatus" class="statusLine"></div>

  <div id="decisionBox" class="resultRow"></div>
</div>

<div class="card">
  <strong>Accept log</strong>
  <div class="muted">Stores BUY decisions on this device (BUY only) so you can export later.</div>

  <div style="margin-top:10px;">
    <button type="button" id="exportAccepts">Export CSV</button>
    <button type="button" id="clearAccepts">Clear log</button>
  </div>

  <div class="muted" id="acceptCount"></div>
  <ul id="acceptList"></ul>
</div>

<div class="card">
  <strong>Last scans</strong>
  <ul id="recent"></ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
/* ===== Config and Persistence ===== */
const LS_EBAY = "media_sniper_ebay_isbn13_list_v1";
const LS_EBAY_TS  = "media_sniper_ebay_isbn13_list_ts_v1";
const LS_AMZ = "media_sniper_amazon_isbn13_list_v1";
const LS_AMZ_TS  = "media_sniper_amazon_isbn13_list_ts_v1";
const LS_WORKER = "media_sniper_booksrun_worker_url_v1";
const LS_ACCEPTS = "media_sniper_accepts_v1";

function setPersistStatusEbay(msg){ document.getElementById("persistStatusEbay").textContent = msg || ""; }
function setPersistStatusAmazon(msg){ document.getElementById("persistStatusAmazon").textContent = msg || ""; }
function setWorkerStatus(msg){ document.getElementById("workerStatus").textContent = msg || ""; }

function saveSetToLocalStorage(key, tsKey, set, setStatusFn){
  try{
    const arr = Array.from(set);
    localStorage.setItem(key, arr.join("\n"));
    localStorage.setItem(tsKey, String(Date.now()));
    setStatusFn(`Saved list on device (${arr.length} ISBNs).`);
  } catch(e){
    setStatusFn("Could not save list (storage blocked or full).");
  }
}

function loadSetFromLocalStorage(key){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return null;
    const lines = raw.split(/\r?\n/).map(x => x.trim()).filter(Boolean);
    if(!lines.length) return null;
    return new Set(lines);
  } catch(e){
    return null;
  }
}

function clearSavedSet(key, tsKey, setStatusFn){
  try{
    localStorage.removeItem(key);
    localStorage.removeItem(tsKey);
  } catch(_) {}
  setStatusFn("Saved list cleared.");
}

function saveWorkerUrl(url){
  try{
    localStorage.setItem(LS_WORKER, url);
    setWorkerStatus("Saved.");
  } catch(_) {
    setWorkerStatus("Could not save Worker URL.");
  }
}

function loadWorkerUrl(){
  try { return localStorage.getItem(LS_WORKER) || ""; } catch(_) { return ""; }
}

/* ===== Accept log ===== */
function loadAccepts(){
  try {
    const raw = localStorage.getItem(LS_ACCEPTS);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  } catch(_) {
    return [];
  }
}

function saveAccepts(arr){
  try {
    localStorage.setItem(LS_ACCEPTS, JSON.stringify(arr));
  } catch(_) {}
}

let accepts = loadAccepts();

function renderAccepts(){
  const elCount = document.getElementById("acceptCount");
  const elList = document.getElementById("acceptList");
  if(!elCount || !elList) return;

  elCount.textContent = `Saved accepts: ${accepts.length}`;
  elList.innerHTML = "";

  const slice = accepts.slice(-20).reverse();
  for(const a of slice){
    const avg = (typeof a.booksrunAvgUsd === "number" && !Number.isNaN(a.booksrunAvgUsd))
      ? `$${a.booksrunAvgUsd.toFixed(2)}`
      : "N/A";

    const also = [];
    if(a.alsoBuyback) also.push("also_buyback");
    if(a.alsoAmazon) also.push("also_amazon");
    const alsoStr = also.length ? ` | ${also.join(" ")}` : "";

    const li = document.createElement("li");
    li.textContent = `${a.timestampLocal} | ${a.lane} | ${a.isbn13} | Avg ${avg} | eBay ${a.ebayHit ? "Y" : "N"} | Amz ${a.amazonHit ? "Y" : "N"}${alsoStr}`;
    elList.appendChild(li);
  }
}

function addAccept(entry){
  accepts.push(entry);
  saveAccepts(accepts);
  renderAccepts();
}

function downloadText(filename, text){
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function acceptsToCsv(rows){
  const header = [
    "timestamp_iso",
    "timestamp_local",
    "isbn13",
    "lane",
    "ebay_hit",
    "amazon_hit",
    "buyback_hit",
    "also_buyback",
    "also_amazon",
    "booksrun_avg_usd",
    "min_usd_threshold",
    "booksrun_status",
    "booksrun_message"
  ];

  const esc = (v) => {
    const s = (v == null) ? "" : String(v);
    if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };

  const lines = [header.join(",")];
  for(const r of rows){
    lines.push([
      esc(r.timestampIso),
      esc(r.timestampLocal),
      esc(r.isbn13),
      esc(r.lane),
      esc(r.ebayHit ? "1" : "0"),
      esc(r.amazonHit ? "1" : "0"),
      esc(r.buybackHit ? "1" : "0"),
      esc(r.alsoBuyback ? "1" : "0"),
      esc(r.alsoAmazon ? "1" : "0"),
      esc((typeof r.booksrunAvgUsd === "number" && !Number.isNaN(r.booksrunAvgUsd)) ? r.booksrunAvgUsd.toFixed(2) : ""),
      esc(r.minUsdThreshold),
      esc(r.booksrunStatus || ""),
      esc(r.booksrunMessage || "")
    ].join(","));
  }
  return lines.join("\n");
}

document.getElementById("exportAccepts").addEventListener("click", () => {
  const csv = acceptsToCsv(accepts);
  const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
  downloadText(`accepts-${ts}.csv`, csv);
});

document.getElementById("clearAccepts").addEventListener("click", () => {
  accepts = [];
  try { localStorage.removeItem(LS_ACCEPTS); } catch(_) {}
  renderAccepts();
});

/* ===== App state ===== */
let ebaySet = new Set();
let amazonSet = new Set();

let lastScanned = null;
let lastScannedIsbn13 = null;

let audioCtx = null;
let soundReady = false;

let ocrWorker = null;
let ocrReady = false;

function cleanDigits(s){
  return (s || "").replace(/[^0-9Xx]/g, "").toUpperCase();
}

function isbn10to13(isbn10){
  const core9 = isbn10.slice(0,9);
  if(!/^\d{9}$/.test(core9)) return null;

  const base12 = "978" + core9;
  let sum = 0;
  for(let i=0;i<12;i++){
    const d = parseInt(base12[i], 10);
    sum += (i % 2 === 0) ? d : 3*d;
  }
  const check = (10 - (sum % 10)) % 10;
  return base12 + check;
}

function normalizeToIsbn13(raw){
  const s = cleanDigits(raw);
  if(/^\d{13}$/.test(s)) return s;
  if(/^\d{10}$/.test(s) || /^\d{9}X$/.test(s)) return isbn10to13(s);
  return null;
}

function isValidIsbn10(isbn10){
  const s = cleanDigits(isbn10);
  if(!/^\d{9}[\dX]$/.test(s)) return false;

  let sum = 0;
  for(let i=0;i<9;i++){
    sum += (10 - i) * parseInt(s[i], 10);
  }
  const last = s[9] === "X" ? 10 : parseInt(s[9], 10);
  sum += last;
  return (sum % 11) === 0;
}

function isValidIsbn13(isbn13){
  const s = cleanDigits(isbn13);
  if(!/^\d{13}$/.test(s)) return false;

  let sum = 0;
  for(let i=0;i<12;i++){
    const d = parseInt(s[i], 10);
    sum += (i % 2 === 0) ? d : 3*d;
  }
  const check = (10 - (sum % 10)) % 10;
  return check === parseInt(s[12], 10);
}

function beep(){
  if(!soundReady || !audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = "square";
  osc.frequency.value = 880;
  gain.gain.value = 0.15;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  setTimeout(() => osc.stop(), 120);
}

function vibrateSuccess(){
  try { if (navigator.vibrate) navigator.vibrate([100, 50, 100]); } catch (_) {}
}

function setLaneState(lane){
  document.body.classList.remove("lane-ebay","lane-buyback","lane-amazon","lane-pass");
  if(lane === "EBAY") document.body.classList.add("lane-ebay");
  else if(lane === "BUYBACK") document.body.classList.add("lane-buyback");
  else if(lane === "AMAZON") document.body.classList.add("lane-amazon");
  else document.body.classList.add("lane-pass");
}

function laneToPillClass(lane){
  if(lane === "EBAY") return "ebay";
  if(lane === "BUYBACK") return "buyback";
  if(lane === "AMAZON") return "amazon";
  return "pass";
}

document.getElementById("enableSound").onclick = async () => {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  await audioCtx.resume();
  soundReady = true;
  document.getElementById("scan").focus();
};

document.getElementById("saveWorkerUrl").addEventListener("click", () => {
  const val = (document.getElementById("workerUrl").value || "").trim();
  if(!val.startsWith("http")) {
    setWorkerStatus("Please paste a full https URL.");
    return;
  }
  saveWorkerUrl(val);
});

/* ===== File import handlers ===== */
async function importListFromFile(file){
  const text = await file.text();
  const lines = text.split(/\r?\n/);
  const set = new Set();
  lines.forEach(line => {
    const n = normalizeToIsbn13(line.trim());
    if(n) set.add(n);
  });
  return set;
}

document.getElementById("fileEbay").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if(!file) return;

  ebaySet = await importListFromFile(file);
  document.getElementById("countEbay").textContent = ebaySet.size;
  setPersistStatusEbay("");
  saveSetToLocalStorage(LS_EBAY, LS_EBAY_TS, ebaySet, setPersistStatusEbay);

  document.getElementById("scan").focus();
});

document.getElementById("fileAmazon").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if(!file) return;

  amazonSet = await importListFromFile(file);
  document.getElementById("countAmazon").textContent = amazonSet.size;
  setPersistStatusAmazon("");
  saveSetToLocalStorage(LS_AMZ, LS_AMZ_TS, amazonSet, setPersistStatusAmazon);

  document.getElementById("scan").focus();
});

document.getElementById("clearSavedEbay").addEventListener("click", () => {
  clearSavedSet(LS_EBAY, LS_EBAY_TS, setPersistStatusEbay);
  ebaySet = new Set();
  document.getElementById("countEbay").textContent = "0";
});

document.getElementById("clearSavedAmazon").addEventListener("click", () => {
  clearSavedSet(LS_AMZ, LS_AMZ_TS, setPersistStatusAmazon);
  amazonSet = new Set();
  document.getElementById("countAmazon").textContent = "0";
});

/* ===== Decision / Render ===== */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function decideLane({ ebayHit, amazonHit, avgUsd }){
  const minUsd = parseFloat(document.getElementById("minUsd").value || "10");
  const hasAvg = (typeof avgUsd === "number") && !Number.isNaN(avgUsd);
  const buybackHit = !!(hasAvg && avgUsd >= minUsd);

  if(ebayHit) return { lane: "EBAY", buybackHit };
  if(buybackHit) return { lane: "BUYBACK", buybackHit };
  if(amazonHit) return { lane: "AMAZON", buybackHit };
  return { lane: "PASS", buybackHit };
}

function renderDecision({ isbn13, ebayHit, amazonHit, avgUsd, booksrunStatus, booksrunMsg }) {
  const hasAvg = (typeof avgUsd === "number") && !Number.isNaN(avgUsd);
  const { lane, buybackHit } = decideLane({ ebayHit, amazonHit, avgUsd });

  setLaneState(lane);

  const isBuy = lane !== "PASS";
  if(isBuy){
    beep();
    vibrateSuccess();
  }

  // Log BUY only, only after BooksRun is done loading
  const isFinal = booksrunStatus && booksrunStatus !== "loading";
  if(isFinal && isBuy && isbn13){
    const now = new Date();
    const minUsdThreshold = parseFloat(document.getElementById("minUsd").value || "10");

    const alsoBuyback = (lane === "EBAY") && !!buybackHit;
    const alsoAmazon  = (lane === "EBAY" || lane === "BUYBACK") && !!amazonHit;

    addAccept({
      timestampIso: now.toISOString(),
      timestampLocal: now.toLocaleString(),
      isbn13,
      lane,
      ebayHit: !!ebayHit,
      amazonHit: !!amazonHit,
      buybackHit: !!buybackHit,
      alsoBuyback,
      alsoAmazon,
      booksrunAvgUsd: (typeof avgUsd === "number" ? avgUsd : null),
      minUsdThreshold,
      booksrunStatus,
      booksrunMessage: booksrunMsg || ""
    });
  }

  const decisionBox = document.getElementById("decisionBox");

  const lanePill = `<span class="pill pill-lane ${laneToPillClass(lane)}">LANE: ${lane}</span>`;
  const ebayPill = `<span class="pill">eBay: ${ebayHit ? "YES" : "NO"}</span>`;
  const amzPill  = `<span class="pill">Amazon: ${amazonHit ? "YES" : "NO"}</span>`;
  const avgPill  = `<span class="pill">BooksRun Avg: ${hasAvg ? ("$" + avgUsd.toFixed(2)) : (booksrunStatus === "loading" ? "..." : "N/A")}</span>`;
  const statPill = `<span class="pill">BooksRun: ${booksrunStatus || "unknown"}</span>`;

  let decisionText = "";
  if(lane === "EBAY") decisionText = `<strong>BUY</strong> (eBay lane)`;
  else if(lane === "BUYBACK") decisionText = `<strong>BUY</strong> (Buyback lane)`;
  else if(lane === "AMAZON") decisionText = `<strong>BUY</strong> (Amazon consignment lane)`;
  else decisionText = `<strong>PASS</strong>`;

  const extra = booksrunMsg ? `<div class="muted">${escapeHtml(booksrunMsg)}</div>` : "";

  const hint = (lane === "EBAY" && buybackHit)
    ? `<div class="muted">Also qualifies for BUYBACK.</div>`
    : (lane === "EBAY" && amazonHit)
      ? `<div class="muted">Also qualifies for AMAZON.</div>`
      : (lane === "BUYBACK" && amazonHit)
        ? `<div class="muted">Also qualifies for AMAZON.</div>`
        : "";

  decisionBox.innerHTML = `
    ${lanePill}
    ${ebayPill}${amzPill}${avgPill}${statPill}
    <div style="margin-top:8px;font-size:18px;">${decisionText}</div>
    <div class="muted">ISBN-13: ${isbn13 || "-"}</div>
    ${hint}
    ${extra}
  `;
}

/* ===== BooksRun lookup ===== */
async function fetchBooksRunAverage(isbn13){
  const workerUrl = (document.getElementById("workerUrl").value || "").trim();
  if(!workerUrl || !workerUrl.startsWith("http")) {
    return { status: "error", message: "Missing Worker URL. Paste and Save it above.", avgUsd: null };
  }

  const url = workerUrl.includes("?")
    ? `${workerUrl}&isbn=${encodeURIComponent(isbn13)}`
    : `${workerUrl}?isbn=${encodeURIComponent(isbn13)}`;

  try{
    const r = await fetch(url, { method: "GET" });
    const payload = await r.json();

    const br = payload && payload.booksrun ? payload.booksrun : null;
    const result = br && br.result ? br.result : null;
    const status = result && result.status ? result.status : (payload.ok ? "ok" : "error");

    let avg = null;
    let msg = null;

    if(result && result.status === "success"){
      const t = result.text || {};
      const avgRaw = t.Average;
      if(avgRaw != null && avgRaw !== ""){
        const num = Number(avgRaw);
        if(!Number.isNaN(num)) avg = num;
      }
      if(avg == null) msg = "BooksRun returned success but no Average price.";
      return { status: "success", message: msg, avgUsd: avg };
    }

    msg = (result && result.text) ? String(result.text) : "BooksRun did not return success.";
    return { status: status || "error", message: msg, avgUsd: null };

  } catch(e){
    return { status: "error", message: "BooksRun lookup failed (network or worker).", avgUsd: null };
  }
}

/* ===== Scan handling ===== */
async function handleScan(value){
  const norm13 = normalizeToIsbn13(value);

  lastScanned = value;
  lastScannedIsbn13 = norm13;

  const li = document.createElement("li");
  li.textContent = value;
  const list = document.getElementById("recent");
  list.prepend(li);
  while(list.children.length > 10) list.removeChild(list.lastChild);

  document.getElementById("scan").value = "";

  if(!norm13){
    renderDecision({ isbn13: null, ebayHit: false, amazonHit: false, avgUsd: null, booksrunStatus: "error", booksrunMsg: "Could not normalize to ISBN-13." });
    return;
  }

  const ebayHit = ebaySet.has(norm13);
  const amazonHit = amazonSet.has(norm13);

  // Render immediately while BooksRun loads
  renderDecision({ isbn13: norm13, ebayHit, amazonHit, avgUsd: null, booksrunStatus: "loading", booksrunMsg: "Checking BooksRun..." });

  const br = await fetchBooksRunAverage(norm13);

  renderDecision({
    isbn13: norm13,
    ebayHit,
    amazonHit,
    avgUsd: br.avgUsd,
    booksrunStatus: br.status,
    booksrunMsg: br.message
  });
}

let timer = null;
document.getElementById("scan").addEventListener("input", () => {
  clearTimeout(timer);
  timer = setTimeout(() => {
    const val = document.getElementById("scan").value.trim();
    if(val) handleScan(val);
  }, 180);
});

document.getElementById("scan").addEventListener("keydown", (e) => {
  if(e.key === "Enter"){
    e.preventDefault();
    const val = document.getElementById("scan").value.trim();
    if(val) handleScan(val);
  }
});

/* ===== External lookups ===== */
function openEbaySoldHigh(){
  const qRaw = lastScannedIsbn13 || cleanDigits(lastScanned || "");
  if(!qRaw) return;

  const q = encodeURIComponent(qRaw);
  const url = `https://www.ebay.ca/sch/i.html?_nkw=${q}&LH_Sold=1&LH_Complete=1&_sop=16`;
  window.open(url, "_blank");
}

function openEbayLiveLow(){
  const qRaw = lastScannedIsbn13 || cleanDigits(lastScanned || "");
  if(!qRaw) return;

  const q = encodeURIComponent(qRaw);
  const url = `https://www.ebay.ca/sch/i.html?_nkw=${q}&_sop=15`;
  window.open(url, "_blank");
}

function openKeepaGtin(){
  const gtin = lastScannedIsbn13 || normalizeToIsbn13(lastScanned || "");
  if(!gtin) return;

  const url = `https://keepa.com/#!search/1-${encodeURIComponent(gtin)}`;
  window.open(url, "_blank");
}

/* ===== OCR helpers ===== */
function setOcrStatus(msg){
  document.getElementById("ocrStatus").textContent = msg || "";
}

function extractIsbnCandidates(text){
  const t = (text || "").replace(/\u00ad/g, "-");
  const lines = t.split(/\r?\n/);
  const isbnLines = lines.filter(line => /isbn/i.test(line));
  const searchText = isbnLines.length ? isbnLines.join("\n") : t;

  const candidates = [];
  const re13 = /(97[89][0-9\-\s]{10,22}[0-9])/g;
  let m;
  while((m = re13.exec(searchText)) !== null){
    candidates.push(m[1]);
  }

  const re10 = /([0-9][0-9\-\s]{8,18}[0-9Xx])/g;
  while((m = re10.exec(searchText)) !== null){
    candidates.push(m[1]);
  }

  const cleaned = candidates
    .map(c => c.replace(/[^0-9Xx]/g, "").toUpperCase())
    .filter(c => c.length === 10 || c.length === 13);

  return [...new Set(cleaned)];
}

function pickBestIsbn(cands){
  for(const c of cands){
    if(c.length === 13 && isValidIsbn13(c)) return c;
  }
  for(const c of cands){
    if(c.length === 10 && isValidIsbn10(c)) return c;
  }
  for(const c of cands){
    if(c.length === 13) return c;
  }
  for(const c of cands){
    if(c.length === 10) return c;
  }
  return null;
}

async function ensureOcrWorker(){
  if(ocrReady && ocrWorker) return;
  if(!window.Tesseract) throw new Error("Tesseract not loaded.");

  setOcrStatus("OCR: loading engine (first time can take a bit) ...");

  ocrWorker = await window.Tesseract.createWorker("eng", 1, {
    logger: (m) => {
      if(m && m.status){
        const pct = (m.progress != null) ? Math.round(m.progress * 100) : null;
        if(pct != null) setOcrStatus(`OCR: ${m.status} (${pct}%)`);
        else setOcrStatus(`OCR: ${m.status}`);
      }
    }
  });

  await ocrWorker.setParameters({
    tessedit_char_whitelist: "0123456789Xx- ISBNisbn",
    preserve_interword_spaces: "1"
  });

  ocrReady = true;
  setOcrStatus("OCR: ready");
}

const ocrBtn = document.getElementById("ocrBtn");
const ocrInput = document.getElementById("ocrInput");

ocrBtn.addEventListener("click", async () => {
  try { await ensureOcrWorker(); } catch(_) {}
  ocrInput.value = "";
  ocrInput.click();
});

ocrInput.addEventListener("change", async (e) => {
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  try{
    await ensureOcrWorker();

    setOcrStatus("OCR: reading photo (pass 1) ...");
    await ocrWorker.setParameters({
      tessedit_char_whitelist: "0123456789Xx- ISBNisbn",
      preserve_interword_spaces: "1"
    });

    let res = await ocrWorker.recognize(file);
    let text = (res && res.data && res.data.text) ? res.data.text : "";

    let candidates = extractIsbnCandidates(text);
    let best = pickBestIsbn(candidates);

    if(!best){
      setOcrStatus("OCR: no clear ISBN found, trying pass 2 ...");
      await ocrWorker.setParameters({
        tessedit_char_whitelist: "0123456789Xx-ISBNisbn",
        preserve_interword_spaces: "1",
        tessedit_pageseg_mode: "6"
      });

      res = await ocrWorker.recognize(file);
      text = (res && res.data && res.data.text) ? res.data.text : "";

      candidates = extractIsbnCandidates(text);
      best = pickBestIsbn(candidates);
    }

    if(!best){
      setOcrStatus("OCR: still no clear ISBN. Try closer photo of ONLY the ISBN line, with better light.");
      return;
    }

    setOcrStatus(`OCR: found ${best}. Checking...`);
    handleScan(best);

    const scanEl = document.getElementById("scan");
    if(scanEl) scanEl.focus();

  } catch(err){
    console.error(err);
    setOcrStatus("OCR: failed. Try again with better lighting, or a closer crop of the ISBN line.");
  }
});

/* ===== Restore saved lists + worker on load ===== */
(function restoreOnStartup(){
  const savedE = loadSetFromLocalStorage(LS_EBAY);
  if(savedE && savedE.size){
    ebaySet = savedE;
    document.getElementById("countEbay").textContent = String(ebaySet.size);

    const ts = localStorage.getItem(LS_EBAY_TS);
    if(ts){
      const d = new Date(parseInt(ts, 10));
      setPersistStatusEbay(`Using saved eBay list from ${d.toLocaleString()}.`);
    } else {
      setPersistStatusEbay("Using saved eBay list on device.");
    }
  } else {
    setPersistStatusEbay("No saved eBay list yet. Import once and it will stay on device.");
  }

  const savedA = loadSetFromLocalStorage(LS_AMZ);
  if(savedA && savedA.size){
    amazonSet = savedA;
    document.getElementById("countAmazon").textContent = String(amazonSet.size);

    const ts = localStorage.getItem(LS_AMZ_TS);
    if(ts){
      const d = new Date(parseInt(ts, 10));
      setPersistStatusAmazon(`Using saved Amazon list from ${d.toLocaleString()}.`);
    } else {
      setPersistStatusAmazon("Using saved Amazon list on device.");
    }
  } else {
    setPersistStatusAmazon("No saved Amazon list yet. Import once and it will stay on device.");
  }

  const w = loadWorkerUrl();
  if(w){
    document.getElementById("workerUrl").value = w;
    setWorkerStatus("Loaded saved Worker URL.");
  } else {
    setWorkerStatus("Paste your Worker URL and Save it.");
  }

  renderAccepts();
  setLaneState("PASS");
})();
</script>

</body>
</html>
