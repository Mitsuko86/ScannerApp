<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Media Sniper Scanner</title>
<style>
  body { font-family: -apple-system, system-ui, sans-serif; margin: 16px; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-bottom: 12px; background: white; }
  input[type="text"] { width: 100%; font-size: 22px; padding: 12px; border-radius: 10px; border: 1px solid #bbb; }
  button { font-size: 16px; padding: 10px 12px; border-radius: 10px; border: 1px solid #888; background: #f5f5f5; margin-right: 6px; margin-top: 6px; }
  ul { margin: 8px 0 0; padding-left: 18px; }
  .muted { color:#666; font-size: 13px; margin-top: 6px; line-height: 1.35; }

  /* Match background state: stays green until next scan changes state */
  .matchState {
    background-color: #c6f7c6;
    transition: background-color 0.25s ease;
  }

  video {
    width: 100%;
    max-width: 520px;
    border-radius: 12px;
    border: 1px solid #ddd;
    display: none;
    margin-top: 10px;
  }

  .statusLine {
    margin-top: 8px;
    font-size: 13px;
    color: #444;
    white-space: pre-wrap;
  }

  /* OCR framing guide box */
  .ocr-guide {
    position: relative;
    width: 100%;
    max-width: 520px;
    height: 140px;
    border: 3px dashed #666;
    border-radius: 14px;
    margin-top: 10px;
    background: rgba(0,0,0,0.03);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .ocr-guide span {
    font-size: 13px;
    color: #444;
    text-align: center;
    padding: 0 10px;
    line-height: 1.3;
  }
  .ocr-guide::after {
    content: "";
    position: absolute;
    left: 14px;
    right: 14px;
    top: 50%;
    height: 2px;
    background: rgba(0,0,0,0.25);
    transform: translateY(-50%);
  }
</style>
</head>
<body>

<h2>Media Sniper Scanner</h2>

<div class="card">
  <strong>List loaded:</strong> <span id="count">0</span> ISBNs<br><br>
  <input id="file" type="file" accept=".txt,.csv" />
  <div class="muted">Tip: one ISBN per line is best. ISBN-10 is normalized to ISBN-13 for matching. Dashes/spaces are OK.</div>
  <div id="persistStatus" class="muted"></div>
  <button type="button" id="clearSaved">Clear saved list</button>
</div>

<div class="card">
  <input id="scan" type="text" placeholder="Scan ISBN..." autocomplete="off" />
  <br><br>

  <button id="enableSound" type="button">Enable sound</button>
  <div class="muted">On iPhone, tap this once so the beep can play.</div>

  <div style="margin-top:10px;">
    <button type="button" onclick="openEbaySoldHigh()">eBay Sold (High to Low)</button>
    <button type="button" onclick="openEbayLiveLow()">eBay Live (Low to High)</button>
    <button type="button" onclick="openKeepaGtin()">Keepa (GTIN search)</button>
  </div>

  <div style="margin-top:10px;">
    <button type="button" id="startCam">Camera scan (barcode)</button>
    <button type="button" id="stopCam" disabled>Stop camera</button>
    <div class="muted">Best for barcodes (EAN/UPC). Fastest option.</div>
  </div>

  <div style="margin-top:10px;">
    <button type="button" id="ocrBtn">Scan printed ISBN (photo)</button>
    <div class="muted">For older books with no barcode. Take a close photo of the ISBN line on the copyright page.</div>

    <div class="ocr-guide">
      <span>Frame the ISBN line across the center line, then tap “Scan printed ISBN (photo)”.</span>
    </div>
  </div>

  <!-- Hidden file input to open camera -->
  <input id="ocrInput" type="file" accept="image/*" capture="environment" style="display:none;" />

  <video id="preview" playsinline></video>
  <div id="camStatus" class="muted"></div>

  <div id="ocrStatus" class="statusLine"></div>
</div>

<div class="card">
  <strong>Last scans</strong>
  <ul id="recent"></ul>
</div>

<!-- OCR library -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
/* ===== Persistence (localStorage) ===== */
const LS_KEY = "media_sniper_isbn13_list_v1"; // stored as newline-separated isbn13
const LS_TS  = "media_sniper_isbn13_list_ts_v1";

function setPersistStatus(msg){
  document.getElementById("persistStatus").textContent = msg || "";
}

function saveListToLocalStorage(set){
  try{
    const arr = Array.from(set);
    localStorage.setItem(LS_KEY, arr.join("\n"));
    localStorage.setItem(LS_TS, String(Date.now()));
    setPersistStatus(`Saved list on device (${arr.length} ISBNs).`);
  } catch(e){
    setPersistStatus("Could not save list (storage blocked or full).");
  }
}

function loadListFromLocalStorage(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    const lines = raw.split(/\r?\n/).map(x => x.trim()).filter(Boolean);
    if(!lines.length) return null;
    return new Set(lines);
  } catch(e){
    return null;
  }
}

function clearSavedList(){
  try{
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(LS_TS);
  } catch(_) {}
  setPersistStatus("Saved list cleared.");
}

/* ===== App state ===== */
let isbnSet = new Set();
let lastScanned = null;
let lastScannedIsbn13 = null;

let audioCtx = null;
let soundReady = false;

// OCR worker cache
let ocrWorker = null;
let ocrReady = false;

function cleanDigits(s){
  return (s || "").replace(/[^0-9Xx]/g, "").toUpperCase();
}

function isbn10to13(isbn10){
  const core9 = isbn10.slice(0,9);
  if(!/^\d{9}$/.test(core9)) return null;

  const base12 = "978" + core9;
  let sum = 0;
  for(let i=0;i<12;i++){
    const d = parseInt(base12[i], 10);
    sum += (i % 2 === 0) ? d : 3*d;
  }
  const check = (10 - (sum % 10)) % 10;
  return base12 + check;
}

function normalizeToIsbn13(raw){
  const s = cleanDigits(raw);
  if(/^\d{13}$/.test(s)) return s;
  if(/^\d{10}$/.test(s) || /^\d{9}X$/.test(s)) return isbn10to13(s);
  return null;
}

function isValidIsbn10(isbn10){
  const s = cleanDigits(isbn10);
  if(!/^\d{9}[\dX]$/.test(s)) return false;

  let sum = 0;
  for(let i=0;i<9;i++){
    sum += (10 - i) * parseInt(s[i], 10);
  }
  const last = s[9] === "X" ? 10 : parseInt(s[9], 10);
  sum += last;
  return (sum % 11) === 0;
}

function isValidIsbn13(isbn13){
  const s = cleanDigits(isbn13);
  if(!/^\d{13}$/.test(s)) return false;

  let sum = 0;
  for(let i=0;i<12;i++){
    const d = parseInt(s[i], 10);
    sum += (i % 2 === 0) ? d : 3*d;
  }
  const check = (10 - (sum % 10)) % 10;
  return check === parseInt(s[12], 10);
}

function beep(){
  if(!soundReady || !audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = "square";
  osc.frequency.value = 880;
  gain.gain.value = 0.15;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  setTimeout(() => osc.stop(), 120);
}

function vibrateSuccess(){
  try {
    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
  } catch (_) {}
}

function setMatchState(isMatch){
  document.body.classList.remove("matchState");
  if(isMatch) document.body.classList.add("matchState");
}

document.getElementById("enableSound").onclick = async () => {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  await audioCtx.resume();
  soundReady = true;
  document.getElementById("scan").focus();
};

document.getElementById("file").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if(!file) return;

  const text = await file.text();
  const lines = text.split(/\r?\n/);

  isbnSet = new Set();
  lines.forEach(line => {
    const n = normalizeToIsbn13(line.trim());
    if(n) isbnSet.add(n);
  });

  document.getElementById("count").textContent = isbnSet.size;
  setPersistStatus("");
  saveListToLocalStorage(isbnSet);

  document.getElementById("scan").focus();
});

document.getElementById("clearSaved").addEventListener("click", () => {
  clearSavedList();
  isbnSet = new Set();
  document.getElementById("count").textContent = "0";
});

function handleScan(value){
  const norm13 = normalizeToIsbn13(value);

  lastScanned = value;
  lastScannedIsbn13 = norm13;

  const isMatch = !!(norm13 && isbnSet.has(norm13));
  setMatchState(isMatch);

  if(isMatch){
    beep();
    vibrateSuccess();
  }

  const li = document.createElement("li");
  li.textContent = value + (isMatch ? "  MATCH" : "");
  const list = document.getElementById("recent");
  list.prepend(li);
  while(list.children.length > 10) list.removeChild(list.lastChild);

  document.getElementById("scan").value = "";
}

let timer = null;
document.getElementById("scan").addEventListener("input", () => {
  clearTimeout(timer);
  timer = setTimeout(() => {
    const val = document.getElementById("scan").value.trim();
    if(val) handleScan(val);
  }, 180);
});

document.getElementById("scan").addEventListener("keydown", (e) => {
  if(e.key === "Enter"){
    e.preventDefault();
    const val = document.getElementById("scan").value.trim();
    if(val) handleScan(val);
  }
});

function openEbaySoldHigh(){
  const qRaw = lastScannedIsbn13 || cleanDigits(lastScanned || "");
  if(!qRaw) return;

  const q = encodeURIComponent(qRaw);
  const url = `https://www.ebay.ca/sch/i.html?_nkw=${q}&LH_Sold=1&LH_Complete=1&_sop=16`;
  window.open(url, "_blank");
}

function openEbayLiveLow(){
  const qRaw = lastScannedIsbn13 || cleanDigits(lastScanned || "");
  if(!qRaw) return;

  const q = encodeURIComponent(qRaw);
  const url = `https://www.ebay.ca/sch/i.html?_nkw=${q}&_sop=15`;
  window.open(url, "_blank");
}

function openKeepaGtin(){
  const gtin = lastScannedIsbn13 || normalizeToIsbn13(lastScanned || "");
  if(!gtin) return;

  const url = `https://keepa.com/#!search/1-${encodeURIComponent(gtin)}`;
  window.open(url, "_blank");
}

/* ===== OCR helpers ===== */
function setOcrStatus(msg){
  document.getElementById("ocrStatus").textContent = msg || "";
}

function extractIsbnCandidates(text){
  const t = (text || "").replace(/\u00ad/g, "-");
  const lines = t.split(/\r?\n/);
  const isbnLines = lines.filter(line => /isbn/i.test(line));
  const searchText = isbnLines.length ? isbnLines.join("\n") : t;

  const candidates = [];
  const re13 = /(97[89][0-9\-\s]{10,22}[0-9])/g;
  let m;
  while((m = re13.exec(searchText)) !== null){
    candidates.push(m[1]);
  }

  const re10 = /([0-9][0-9\-\s]{8,18}[0-9Xx])/g;
  while((m = re10.exec(searchText)) !== null){
    candidates.push(m[1]);
  }

  const cleaned = candidates
    .map(c => c.replace(/[^0-9Xx]/g, "").toUpperCase())
    .filter(c => c.length === 10 || c.length === 13);

  return [...new Set(cleaned)];
}

function pickBestIsbn(cands){
  for(const c of cands){
    if(c.length === 13 && isValidIsbn13(c)) return c;
  }
  for(const c of cands){
    if(c.length === 10 && isValidIsbn10(c)) return c;
  }
  for(const c of cands){
    if(c.length === 13) return c;
  }
  for(const c of cands){
    if(c.length === 10) return c;
  }
  return null;
}

async function ensureOcrWorker(){
  if(ocrReady && ocrWorker) return;
  if(!window.Tesseract) throw new Error("Tesseract not loaded.");

  setOcrStatus("OCR: loading engine (first time can take a bit) ...");

  ocrWorker = await window.Tesseract.createWorker("eng", 1, {
    logger: (m) => {
      if(m && m.status){
        const pct = (m.progress != null) ? Math.round(m.progress * 100) : null;
        if(pct != null) setOcrStatus(`OCR: ${m.status} (${pct}%)`);
        else setOcrStatus(`OCR: ${m.status}`);
      }
    }
  });

  await ocrWorker.setParameters({
    tessedit_char_whitelist: "0123456789Xx- ISBNisbn",
    preserve_interword_spaces: "1"
  });

  ocrReady = true;
  setOcrStatus("OCR: ready");
}

const ocrBtn = document.getElementById("ocrBtn");
const ocrInput = document.getElementById("ocrInput");

ocrBtn.addEventListener("click", async () => {
  try { await ensureOcrWorker(); } catch(_) {}
  ocrInput.value = "";
  ocrInput.click();
});

ocrInput.addEventListener("change", async (e) => {
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  try{
    await ensureOcrWorker();

    // Pass 1
    setOcrStatus("OCR: reading photo (pass 1) ...");
    await ocrWorker.setParameters({
      tessedit_char_whitelist: "0123456789Xx- ISBNisbn",
      preserve_interword_spaces: "1"
    });

    let res = await ocrWorker.recognize(file);
    let text = (res && res.data && res.data.text) ? res.data.text : "";

    let candidates = extractIsbnCandidates(text);
    let best = pickBestIsbn(candidates);

    // Pass 2 if needed
    if(!best){
      setOcrStatus("OCR: no clear ISBN found, trying pass 2 ...");
      await ocrWorker.setParameters({
        tessedit_char_whitelist: "0123456789Xx-ISBNisbn",
        preserve_interword_spaces: "1",
        tessedit_pageseg_mode: "6"
      });

      res = await ocrWorker.recognize(file);
      text = (res && res.data && res.data.text) ? res.data.text : "";

      candidates = extractIsbnCandidates(text);
      best = pickBestIsbn(candidates);
    }

    if(!best){
      setOcrStatus("OCR: still no clear ISBN. Try closer photo of ONLY the ISBN line, with better light.");
      return;
    }

    setOcrStatus(`OCR: found ${best}. Checking...`);
    handleScan(best);

    const scanEl = document.getElementById("scan");
    if(scanEl) scanEl.focus();

  } catch(err){
    console.error(err);
    setOcrStatus("OCR: failed. Try again with better lighting, or a closer crop of the ISBN line.");
  }
});

/* ===== Restore saved list on load ===== */
(function restoreListOnStartup(){
  const saved = loadListFromLocalStorage();
  if(saved && saved.size){
    isbnSet = saved;
    document.getElementById("count").textContent = String(isbnSet.size);

    const ts = localStorage.getItem(LS_TS);
    if(ts){
      const d = new Date(parseInt(ts, 10));
      setPersistStatus(`Using saved list from ${d.toLocaleString()}.`);
    } else {
      setPersistStatus("Using saved list on device.");
    }
  } else {
    setPersistStatus("No saved list yet. Import your list once and it will stay on device.");
  }
})();
</script>

<!-- Camera barcode scanning (ZXing) -->
<script type="module">
  import { BrowserMultiFormatReader } from "https://unpkg.com/@zxing/browser@0.1.5/esm/index.min.js";

  const startBtn = document.getElementById("startCam");
  const stopBtn = document.getElementById("stopCam");
  const videoEl = document.getElementById("preview");
  const statusEl = document.getElementById("camStatus");

  let codeReader = null;
  let controls = null;

  function setStatus(msg){ statusEl.textContent = msg || ""; }

  async function startCameraScan(){
    try{
      setStatus("Requesting camera permission...");
      startBtn.disabled = true;

      videoEl.style.display = "block";
      codeReader = new BrowserMultiFormatReader();

      const constraints = { video: { facingMode: "environment" }, audio: false };

      controls = await codeReader.decodeFromConstraints(constraints, videoEl, (result, err) => {
        if(result){
          const text = result.getText();
          stopCameraScan();
          handleScan(text);
          setStatus("Scanned: " + text);
        }
      });

      stopBtn.disabled = false;
      setStatus("Scanning... aim at the barcode.");
    } catch(e){
      console.error(e);
      setStatus("Camera failed. Check iPhone Settings > Safari > Camera (Allow).");
      videoEl.style.display = "none";
      startBtn.disabled = false;
    }
  }

  function stopCameraScan(){
    try { if(controls) controls.stop(); } catch(_) {}
    try { if(codeReader) codeReader.reset(); } catch(_) {}

    controls = null;
    codeReader = null;

    videoEl.style.display = "none";
    stopBtn.disabled = true;
    startBtn.disabled = false;

    const scanEl = document.getElementById("scan");
    if(scanEl) scanEl.focus();
  }

  startBtn.addEventListener("click", startCameraScan);
  stopBtn.addEventListener("click", stopCameraScan);
</script>

</body>
</html>
